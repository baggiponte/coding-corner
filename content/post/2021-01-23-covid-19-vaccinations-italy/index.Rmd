---
title: 'COVID-19 Vaccinations Data: Some Visualisations for Italy'
author: 'Luca Baggi'
date: '2021-01-23'
slug: 'covid-19-vaccinations-italy'
categories: []
tags: []
ShowToc: true
---

Now, let's get produce some more informative visualisations.

```{r, message=FALSE}
library(tidyverse)
theme_set(theme_minimal())
```

# Load Data

```{r, message=FALSE}
read_csv(
  'https://raw.githubusercontent.com/orizzontipolitici/covid19-vaccine-data/main/data_ita/doses_by_date_ita.csv',
) -> doses_by_date 

read_csv(
  'https://raw.githubusercontent.com/orizzontipolitici/covid19-vaccine-data/main/data_ita/vaccinations_by_area_ita.csv',
  col_types = cols(
    area = col_factor()
  )) -> vaccinations_by_area
```

These two datasets are incompatible and we need to:

* Add missing dates to complete the time series.
* `group_by(date)` to obtain the time series for Italian data.

```{r}
# create the grid
dates_grid <-
  expand_grid(
    data = seq.Date(
      from = min(vaccinations_by_area$data), to = max(vaccinations_by_area$data), by = 'day'
    ),
    area = forcats::fct_unique(vaccinations_by_area$area)
  )

vaccinations_by_area %>%
  # perform the join
  full_join(dates_grid, by = c('area', 'data')) %>%
  # reorder data
  arrange(area, data) %>%
  # replace NA with 0
  mutate(across(!ends_with(c('totale', 'data', 'area')), ~ coalesce(.x, 0))) %>%
  # fill cumsum columns with precedent value
  # actually unneeded!
  fill(ends_with('totale')) %>%
  # group by data
  group_by(data) %>%
  summarise(across(!ends_with(c('totale', 'area', 'data')), sum)) -> vaccinations_by_date
```

Now that the two are compatible, we can join them. We shall drop `over80` as the data is not being entered correctly at the moment.

```{r}
vaccinations_by_date %<>%
  select(-over80) %>%
  inner_join(doses_by_date) %>%
  rename(
    consegne_pfizer = totale_pfizer,
    consegne_moderna = totale_moderna,
    nuove_consegne = totale_dosi_consegnate,
    dosi_totale = totale_dosi
  ) %>%
  mutate(
    # create cumulative columns
    across(2:8, list(totale = cumsum)),
    # let's add population data
    popolazione_2020 = 59641488,
    dosi_percento = round(dosi_totale / popolazione_2020 * 1000, digits = 2),
    vaccinazioni_percento = round(nuovi_vaccinati_totale / popolazione_2020 * 1000, digits = 2),
    dosi_usate_percento = round(nuovi_vaccinati_totale / dosi_totale * 100, digits = 2)
  ) %>%
  rename(vaccinati_totale = nuovi_vaccinati_totale)
  
vaccinations_by_date
```
Now we can plot this!

```{r}
vaccinations_by_date %>%
  ggplot(aes(
   x = data,
   y = dosi_totale
  )) +
  geom_area(fill = 'salmon') +
  geom_line(aes(y = vaccinati_totale)) +
  theme_minimal() +
  labs(
    title = 'Total Doses and Doses Injected Over Time',
    x = 'Date',
    y = NULL
  )

vaccinations_by_date %>%
  ggplot(aes(
    x = data,
    y = nuovi_vaccinati
  )) +
  geom_line() +
  labs(
    title = 'Doses Injected by Day',
    x = 'Date',
    y = NULL
  )
```

Things I learned: if you put `geom_area()` last, it will cover everything else.

# Who's doing better?

```{r}
totals_by_area <- read_csv(
  'https://raw.githubusercontent.com/orizzontipolitici/covid19-vaccine-data/main/data_ita/totals_by_area_ita.csv', col_types = cols(area = col_factor())
) %>%
  select(-NUTS2, -nome)

totals_by_area
```


```{r}
totals_by_area %>%
  filter(area != 'ITA') %>%
  ggplot(aes(
    x = dosi_ogni_mille,
    y = vaccinati_ogni_mille
  )) +
  geom_vline(xintercept = mean(totals_by_area$dosi_ogni_mille), color = 'grey') +
  geom_hline(yintercept = mean(totals_by_area$vaccinati_ogni_mille), color = 'grey') +
  geom_text(aes(label = area)) +
  # xlim(0,100) +
  # ylim(0,100) +
  labs(
    title = 'Quale regione è più avanti?',
    subtitle = 'Dosi ricevute e dosi somministrate ogni 1000 abitanti',
    x = NULL,
    y = NULL
  )
  
```

