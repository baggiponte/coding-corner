---
title: 'COVID-19 Vaccinations Data: Some Visualisations for Italy'
author: 'Luca Baggi'
date: '2021-01-23'
slug: 'covid-19-vaccinations-italy-visualisations'
categories: []
tags:
  - covid19
ShowToc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE, warning = FALSE, message = FALSE, 
                      # tidy = "styler", fig.width = 8, fig.height = 5,
                      echo = TRUE, dpi = 300, cache.lazy = FALSE)
```

Now that we have wrangled the data a bit, we can proceed with some visualisations. We want to plot three things:

-   How many vaccinations are administered daily.
-   How many doses have been administered so far and their ratio.
-   See how regions perform in terms of doses administered and doses received.

```{r}
library(tidyverse)

theme_set(theme_minimal())
```

# Data Wrangling

Let's load the data:

```{r}
read_csv(
  'https://raw.githubusercontent.com/orizzontipolitici/covid19-vaccine-data/main/data_ita/doses_by_date_ita.csv',
) -> doses_by_date 

read_csv(
  'https://raw.githubusercontent.com/orizzontipolitici/covid19-vaccine-data/main/data_ita/vaccinations_by_area_ita.csv') %>%
  mutate(area = as.factor(area)) -> vaccinations_by_area
```

These two datasets are incompatible and we need to:

-   Add missing dates to complete the time series.
-   `group_by(date)` to obtain the time series for Italian data.

```{r}
# create the grid
dates_grid <-
  expand_grid(
    data = seq.Date(from = min(vaccinations_by_area$data),
                    to = max(vaccinations_by_area$data),
                    by = 'day'),
    area = forcats::fct_unique(vaccinations_by_area$area)
  )

vaccinations_by_area %>%
  # perform the join
  full_join(dates_grid, by = c('area', 'data')) %>%
  # reorder data
  arrange(area, data) %>%
  # replace NA with 0
  mutate(across(!ends_with(c('totale', 'data', 'area')), ~ coalesce(.x, 0))) %>%
  # fill cumsum columns with precedent value
  # actually unneeded because we will be summarising
  fill(ends_with('totale')) %>%
  # group by data
  group_by(data) %>%
  summarise(across(!ends_with(c('totale', 'area', 'data')), sum)) -> vaccinations_by_date
```

Alternatively, `data = full_seq(vaccinations$data, 1)` would have worked, too!

Now that the two are compatible, we can join them. We shall drop `over80` as the data is not being entered correctly at the moment.

```{r, message=FALSE}
vaccinations_by_date %<>%
  select(-over80) %>%
  inner_join(doses_by_date) %>%
  rename(
    consegne_pfizer = totale_pfizer,
    consegne_moderna = totale_moderna,
    consegne_totale = totale_dosi_consegnate,
    dosi_totale = totale_dosi
  ) %>%
  mutate(
    # create cumulative columns
    across(2:9, list(totale = cumsum)),
    # let's add population data
    popolazione_2020 = 59641488,
    dosi_percento = round(dosi_totale / popolazione_2020 * 1000, digits = 2),
    vaccinazioni_percento = round(nuovi_vaccinati_totale / popolazione_2020 * 1000, digits = 2),
    dosi_usate_percento = round(nuovi_vaccinati_totale / dosi_totale * 100, digits = 2)
  ) %>%
  rename(vaccinati_totale = nuovi_vaccinati_totale) %>%
  select(-popolazione_2020)
```

# First vs Second Doses

Now we can plot some things. Let's start with the daily vaccinations.

```{r}
vaccinations_by_date %>%
  # filter(data != last(data)) %>% # if data is not fully updated the last day
  ggplot(aes(
    x = data,
  )) +
  geom_line(aes(y = prima_dose), col = 'salmon') +
  geom_line(aes(y = seconda_dose), col = 'navy') +
  labs(
    title = 'Doses Injected by Day',
    subtitle = 'Red is first doses, blue is second doses',
    x = 'Date',
    y = NULL
  )
```

Let's plot the cumulative data.

```{r}
vaccinations_by_date %>%
  select(data, prima_dose, seconda_dose) %>%
  mutate(across(-data, cumsum)) %>%
  pivot_longer(!data, names_to = 'dose', values_to = 'numero') %>%
  mutate(dose = fct_relevel(dose, 'seconda_dose', .after = 'prima_dose')) %>%
  ggplot(aes(data, numero, fill = dose)) +
  geom_area() +
  scale_fill_viridis_d(begin = 0.95, end = 0.55) +
  labs(
    title = 'Vaccinations in Italy',
    subtitle = 'Cumulative First and Second Doses Administered',
    x = NULL,
    y = NULL,
    fill = NULL
  ) +
  theme(legend.position = 'bottom')
```

Another useful way to compare how doses are being administered is to compare how their share changes over time. We are not working on cumulative quantities, but the daily increase.

```{r}
vaccinations_by_date %>%
  select(data, prima_dose, seconda_dose) %>%
  mutate(across(-data, ~ .x / (prima_dose + seconda_dose))) %>%
  pivot_longer(!data, names_to = 'dose', values_to = 'pct') %>%
  mutate(dose = fct_relevel(dose, 'seconda_dose', .after = 'prima_dose')) %>%
  ggplot(aes(data, pct, fill = dose)) +
  geom_area() +
  scale_fill_viridis_d(begin = 0.95, end = 0.55) +
  labs(
    title = '% of First Doses v. Second Doses in Italy',
    x = NULL,
    y = NULL,
    fill = NULL
  ) +
  scale_y_continuous(labels = scales::percent) +
  theme(legend.position = 'bottom')
```

# Vaccinations and Doses Injected

```{r}
vaccinations %>%
  group_by(fornitore, data, area) %>%
  summarise(across(where(is.numeric), sum)) %>%
  arrange(area, data)
```


And then see how the total vaccinations compare to the total doses delivered:

```{r}
vaccinations_by_date %>%
  ggplot(aes(
   x = data,
   y = dosi_totale
  )) +
  geom_area(fill = 'salmon') +
  geom_line(aes(y = vaccinati_totale)) +
  labs(
    title = 'Total Doses and Doses Injected Over Time',
    x = 'Date',
    y = NULL
  )
```

Things I learned: if you put `geom_area()` last, it will cover everything else.

# Who's doing better?

Let's use some other data to find the region which is performing better.

```{r}
read_csv('https://raw.githubusercontent.com/orizzontipolitici/covid19-vaccine-data/main/data_ita/totals_by_area_ita.csv') %>%
  select(-NUTS2, -nome) %>%
  mutate(area = as.factor(area)) -> totals_by_area
```

```{r}
totals_by_area %>%
  filter(area != 'ITA') %>%
  ggplot(aes(
    x = dosi_ogni_mille,
    y = vaccinati_ogni_mille
  )) +
  geom_vline(xintercept = mean(totals_by_area$dosi_ogni_mille), color = 'grey') +
  geom_hline(yintercept = mean(totals_by_area$vaccinati_ogni_mille), color = 'grey') +
  geom_text(aes(label = area)) +
  # xlim(0,100) +
  # ylim(0,100) +
  labs(
    title = 'Which Region is Ahead?',
    subtitle = 'Doses delivered compared to doses injected',
    x = NULL,
    y = NULL
  )
```
