---
title: 'COVID-19 Vaccinations Data: Some Visualisations for Italy'
author: 'Luca Baggi'
date: '2021-01-23'
slug: 'covid-19-vaccinations-italy-visualisations'
categories: []
tags:
  - covid19
ShowToc: true
---

<script src="{{< blogdown/postref >}}index_files/header-attrs/header-attrs.js"></script>


<p>Now that we have wrangled the data a bit, we can proceed with some visualisations. We want to plot three things:</p>
<ul>
<li>How many vaccinations are administered daily.</li>
<li>How many doses have been administered so far and their ratio.</li>
<li>See how regions perform in terms of doses administered and doses received.</li>
</ul>
<pre class="r"><code>library(tidyverse)

theme_set(theme_minimal())</code></pre>
<div id="data-wrangling" class="section level1">
<h1>Data Wrangling</h1>
<p>Let’s load the data:</p>
<pre class="r"><code>read_csv(
  &#39;https://raw.githubusercontent.com/orizzontipolitici/covid19-vaccine-data/main/data_ita/doses_by_date_ita.csv&#39;,
) -&gt; doses_by_date 

read_csv(
  &#39;https://raw.githubusercontent.com/orizzontipolitici/covid19-vaccine-data/main/data_ita/vaccinations_by_area_ita.csv&#39;) %&gt;%
  mutate(area = as.factor(area)) -&gt; vaccinations_by_area</code></pre>
<p>These two datasets are incompatible and we need to:</p>
<ul>
<li>Add missing dates to complete the time series.</li>
<li><code>group_by(date)</code> to obtain the time series for Italian data.</li>
</ul>
<pre class="r"><code># create the grid
dates_grid &lt;-
  expand_grid(
    data = seq.Date(from = min(vaccinations_by_area$data),
                    to = max(vaccinations_by_area$data),
                    by = &#39;day&#39;),
    area = forcats::fct_unique(vaccinations_by_area$area)
  )

vaccinations_by_area %&gt;%
  # perform the join
  full_join(dates_grid, by = c(&#39;area&#39;, &#39;data&#39;)) %&gt;%
  # reorder data
  arrange(area, data) %&gt;%
  # replace NA with 0
  mutate(across(!ends_with(c(&#39;totale&#39;, &#39;data&#39;, &#39;area&#39;)), ~ coalesce(.x, 0))) %&gt;%
  # fill cumsum columns with precedent value
  # actually unneeded because we will be summarising
  fill(ends_with(&#39;totale&#39;)) %&gt;%
  # group by data
  group_by(data) %&gt;%
  summarise(across(!ends_with(c(&#39;totale&#39;, &#39;area&#39;, &#39;data&#39;)), sum)) -&gt; vaccinations_by_date</code></pre>
<p>Alternatively, <code>data = full_seq(vaccinations$data, 1)</code> would have worked, too!</p>
<p>Now that the two are compatible, we can join them. We shall drop <code>over80</code> as the data is not being entered correctly at the moment.</p>
<pre class="r"><code>vaccinations_by_date %&lt;&gt;%
  select(-over80) %&gt;%
  inner_join(doses_by_date) %&gt;%
  rename(
    consegne_pfizer = totale_pfizer,
    consegne_moderna = totale_moderna,
    consegne_totale = totale_dosi_consegnate,
    dosi_totale = totale_dosi
  ) %&gt;%
  mutate(
    # create cumulative columns
    across(2:9, list(totale = cumsum)),
    # let&#39;s add population data
    popolazione_2020 = 59641488,
    dosi_percento = round(dosi_totale / popolazione_2020 * 1000, digits = 2),
    vaccinazioni_percento = round(nuovi_vaccinati_totale / popolazione_2020 * 1000, digits = 2),
    dosi_usate_percento = round(nuovi_vaccinati_totale / dosi_totale * 100, digits = 2)
  ) %&gt;%
  rename(vaccinati_totale = nuovi_vaccinati_totale) %&gt;%
  select(-popolazione_2020)</code></pre>
</div>
<div id="first-vs-second-doses" class="section level1">
<h1>First vs Second Doses</h1>
<p>Now we can plot some things. Let’s start with the daily vaccinations.</p>
<pre class="r"><code>vaccinations_by_date %&gt;%
  # filter(data != last(data)) %&gt;% # if data is not fully updated the last day
  ggplot(aes(
    x = data,
  )) +
  geom_line(aes(y = prima_dose), col = &#39;salmon&#39;) +
  geom_line(aes(y = seconda_dose), col = &#39;navy&#39;) +
  labs(
    title = &#39;Doses Injected by Day&#39;,
    subtitle = &#39;Red is first doses, blue is second doses&#39;,
    x = &#39;Date&#39;,
    y = NULL
  )</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-5-1.png" width="2100" /></p>
<p>Let’s plot the cumulative data.</p>
<pre class="r"><code>vaccinations_by_date %&gt;%
  select(data, prima_dose, seconda_dose) %&gt;%
  mutate(across(-data, cumsum)) %&gt;%
  pivot_longer(!data, names_to = &#39;dose&#39;, values_to = &#39;numero&#39;) %&gt;%
  mutate(dose = fct_relevel(dose, &#39;seconda_dose&#39;, .after = &#39;prima_dose&#39;)) %&gt;%
  ggplot(aes(data, numero, fill = dose)) +
  geom_area() +
  scale_fill_viridis_d(begin = 0.95, end = 0.55) +
  labs(
    title = &#39;Vaccinations in Italy&#39;,
    subtitle = &#39;Cumulative First and Second Doses Administered&#39;,
    x = NULL,
    y = NULL,
    fill = NULL
  ) +
  theme(legend.position = &#39;bottom&#39;)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-6-1.png" width="2100" /></p>
<p>Another useful way to compare how doses are being administered is to compare how their share changes over time. We are not working on cumulative quantities, but the daily increase.</p>
<pre class="r"><code>vaccinations_by_date %&gt;%
  select(data, prima_dose, seconda_dose) %&gt;%
  mutate(across(-data, ~ .x / (prima_dose + seconda_dose))) %&gt;%
  pivot_longer(!data, names_to = &#39;dose&#39;, values_to = &#39;pct&#39;) %&gt;%
  mutate(dose = fct_relevel(dose, &#39;seconda_dose&#39;, .after = &#39;prima_dose&#39;)) %&gt;%
  ggplot(aes(data, pct, fill = dose)) +
  geom_area() +
  scale_fill_viridis_d(begin = 0.95, end = 0.55) +
  labs(
    title = &#39;% of First Doses v. Second Doses in Italy&#39;,
    x = NULL,
    y = NULL,
    fill = NULL
  ) +
  scale_y_continuous(labels = scales::percent) +
  theme(legend.position = &#39;bottom&#39;)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-7-1.png" width="2100" /></p>
</div>
<div id="vaccinations-and-doses-injected" class="section level1">
<h1>Vaccinations and Doses Injected</h1>
<p>And then see how the total vaccinations compare to the total doses delivered:</p>
<pre class="r"><code>vaccinations_by_date %&gt;%
  ggplot(aes(
   x = data,
   y = dosi_totale
  )) +
  geom_area(fill = &#39;salmon&#39;) +
  geom_line(aes(y = vaccinati_totale)) +
  theme_minimal() +
  labs(
    title = &#39;Total Doses and Doses Injected Over Time&#39;,
    x = &#39;Date&#39;,
    y = NULL
  )</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-8-1.png" width="2100" /></p>
<p>Things I learned: if you put <code>geom_area()</code> last, it will cover everything else.</p>
<pre><code></code></pre>
</div>
<div id="whos-doing-better" class="section level1">
<h1>Who’s doing better?</h1>
<p>Let’s use some other data to find the region which is performing better.</p>
<pre class="r"><code>read_csv(&#39;https://raw.githubusercontent.com/orizzontipolitici/covid19-vaccine-data/main/data_ita/totals_by_area_ita.csv&#39;) %&gt;%
  select(-NUTS2, -nome) %&gt;%
  mutate(area = as.factor(area)) -&gt; totals_by_area</code></pre>
<pre class="r"><code>totals_by_area %&gt;%
  filter(area != &#39;ITA&#39;) %&gt;%
  ggplot(aes(
    x = dosi_ogni_mille,
    y = vaccinati_ogni_mille
  )) +
  geom_vline(xintercept = mean(totals_by_area$dosi_ogni_mille), color = &#39;grey&#39;) +
  geom_hline(yintercept = mean(totals_by_area$vaccinati_ogni_mille), color = &#39;grey&#39;) +
  geom_text(aes(label = area)) +
  # xlim(0,100) +
  # ylim(0,100) +
  labs(
    title = &#39;Which Region is Ahead?&#39;,
    subtitle = &#39;Doses delivered compared to doses injected&#39;,
    x = NULL,
    y = NULL
  )</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-12-1.png" width="2100" /></p>
</div>
